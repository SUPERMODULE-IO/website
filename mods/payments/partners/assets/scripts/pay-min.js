import{USDCABI}from'./config-min.js';import{ethers}from"https://cdnjs.cloudflare.com/ajax/libs/ethers/6.3.0/ethers.js";const loadButton=document.getElementById("loadButton");let metamaskEnabled=false;const scriptURL='https://script.google.com/macros/s/AKfycbzKRh9JkE-KEFEHJx-ubNr5J5eeqKt_0MTEVFfqKWUtj-dYkFoM0LOjE2psJiKt44iQ/exec';window.addEventListener('load',function(){if(window.ethereum){console.log('Ethereum support is available')
if(window.ethereum.isMetaMask){console.log('MetaMask is active')
metamaskEnabled=true;}else{alert('MetaMask is not available')}}else{console.log('Ethereum support is not found')}})
const switchToMatic=async()=>{await window.ethereum.request({method:"wallet_addEthereumChain",params:[{chainId:"0x89",rpcUrls:["https://polygon-rpc.com/"],chainName:"Matic Mainnet",nativeCurrency:{name:"MATIC",symbol:"MATIC",decimals:18},blockExplorerUrls:["https://explorer.matic.network"]}]});}
export const getProducts=async()=>{loadButton.disabled=true;loadButton.innerHTML=`Loading...ðŸš€`;loadButton.classList.add('animate-pulse');let urlWithParams=scriptURL+'?catalog=true';var noproducts=false;var responseData;await fetch(urlWithParams,{method:'GET',headers:{'Content-Type':'application/x-www-form-urlencoded'}}).then(response=>response.json().then(data=>({data:console.log('RDATA',('error'==data.result)?console.log('ERROR::'+data.message,('no products'==data.message)?noproducts=true:noproducts=false):(responseData=data)),status:response.status}))).catch(error=>console.error('NetworkError:',alert('NETWORK ERROR::'+error)))
var content=document.getElementById('contentDiv');for(let i=0;i<responseData.products.length;i++){const formatter=new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',});var price=formatter.format(responseData.products[i].p_price);var service=document.createElement('div');service.className="p-4 xl:w-1/4 md:w-1/2 w-full";service.innerHTML=`<div
class="h-full p-6 rounded-lg border-2 bg-white shadow-md shadow-black border-primary2 flex flex-col relative overflow-hidden"><span class="bg-primary2 text-white px-3 py-1 tracking-widest text-xs absolute right-0 top-0 rounded-bl">${responseData.products[i].business_name}</span><h2 class="text-sm tracking-widest title-font mb-1 font-medium">${responseData.products[i].p_name}</h2><h1
class="text-1xl font-semibold text-gray-900 leading-none flex items-center pb-4 mb-4 border-b border-gray-200"><span>${price}USDC</span></h1><p class="flex items-center text-gray-600 mb-2 text-sm"><span
class="w-4 h-4 mr-2 inline-flex items-center justify-center bg-primary2 text-white rounded-full flex-shrink-0"><svg fill="none"stroke="currentColor"stroke-linecap="round"stroke-linejoin="round"stroke-width="2.5"
class="w-3 h-3"viewBox="0 0 24 24"><path d="M20 6L9 17l-5-5"></path></svg></span>${responseData.products[i].p_desc}</p><button id="pay${responseData.products[i].p_id}"
class="shadow-md shadow-black flex items-center mt-auto text-white bg-blue-500 border-0 py-2 px-4 w-full focus:outline-none hover:bg-primary2 disabled:opacity-25 rounded"
onclick="payNow('${responseData.products[i].p_price}','${responseData.products[i].d_contract}',${responseData.products[i].p_id});"${(metamaskEnabled)?'':'disabled'}>${(metamaskEnabled)?'Pay Now':'wallet not found!'}<svg fill="none"stroke="currentColor"stroke-linecap="round"stroke-linejoin="round"stroke-width="2"
class="w-4 h-4 ml-auto"viewBox="0 0 24 24"><path d="M5 12h14M12 5l7 7-7 7"></path></svg></button><br><button id="pay${responseData.products[i].p_id}"
class="shadow-md shadow-black flex items-center mt-auto text-white bg-blue-500 border-0 py-2 px-4 w-full focus:outline-none hover:bg-primary2 disabled:opacity-25 rounded"
onclick="window.open('https://polygonscan.com/address/${responseData.products[i].d_contract}#tokentxns','_blank');">View Transactions<svg fill="none"stroke="currentColor"stroke-linecap="round"stroke-linejoin="round"stroke-width="2"
class="w-4 h-4 ml-auto"viewBox="0 0 24 24"><path d="M5 12h14M12 5l7 7-7 7"></path></svg></button><p class="text-xs text-gray-500 mt-3">For any support related to this service please reach out to<a class="text-blue-600"href="mailto:${responseData.products[i].b_email}?subject=Support Request for ${responseData.products[i].p_name}&body=Please describe your support needs.">${responseData.products[i].b_email}</a></p></div>`;content.appendChild(service);}
loadButton.classList.add('hidden');}
export async function payNow(amount,dcontract,pid){document.getElementById('pay'+pid).disabled=true;document.getElementById('pay'+pid).innerHTML=`Processing...`;document.getElementById('pay'+pid).classList.add('animate-pulse');await switchToMatic();const provider=await new ethers.BrowserProvider(window.ethereum)
const signer=await provider.getSigner()
const USDCMaticTokenContract=await new ethers.Contract('0x2791Bca1f2de4661ED88A30C99A7a9449Aa84174',USDCABI(),signer);const txn=await USDCMaticTokenContract.transfer(dcontract,ethers.parseUnits(amount,6)).then((transaction)=>{console.dir("RESULT::"+transaction)
alert("Payment Initiated")
transaction.wait()
then((receipt)=>{alert("Payment Successful")}).catch(err=>alert("ERROR::"+err.reason))}).catch(err=>alert(err.reason))
document.getElementById('pay'+pid).disabled=false;document.getElementById('pay'+pid).innerHTML=`Pay Now`;document.getElementById('pay'+pid).classList.remove('animate-pulse');}