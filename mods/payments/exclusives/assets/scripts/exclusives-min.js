import{USDCABI,PAY_V1_ABI}from'./config-min.js';import{ethers}from"https://cdnjs.cloudflare.com/ajax/libs/ethers/6.3.0/ethers.js";const withdrawMenu=document.getElementById("withdrawMenu");let metamaskEnabled=false;const scriptURL='https://script.google.com/macros/s/AKfycbyqNRuln9cIEoxIOy2ROD85G9pX2qpT-auf25YwbCWVPtOe-qA-ylP_RMUbYibZlsPotg/exec';const menu=document.querySelector('#menu');const button=document.querySelector('#menu-button');button.addEventListener('click',()=>{menu.classList.toggle('hidden');});withdrawMenu.addEventListener("click",function(){withdrawNow();});window.addEventListener('load',function(){if(window.ethereum){console.log('Ethereum support is available')
if(window.ethereum.isMetaMask){console.log('MetaMask is active')
metamaskEnabled=true;}else{alert('MetaMask is not available')}}else{console.log('Ethereum support is not found')}})
const switchToMatic=async()=>{await window.ethereum.request({method:"wallet_addEthereumChain",params:[{chainId:"0x89",rpcUrls:["https://polygon-rpc.com/"],chainName:"Matic Mainnet",nativeCurrency:{name:"MATIC",symbol:"MATIC",decimals:18},blockExplorerUrls:["https://explorer.matic.network"]}]});}
export const getProducts=async()=>{document.getElementById("loadButton").innerHTML=`Loading...ðŸš—`;document.getElementById("loadButton").classList.add('animate-ping');let urlWithParams=scriptURL+'?catalog=true';var noproducts=false;var responseData;await fetch(urlWithParams,{method:'GET',headers:{'Content-Type':'application/x-www-form-urlencoded'}}).then(response=>response.json().then(data=>({data:console.log('RDATA',('error'==data.result)?console.log('ERROR::'+data.message,('no products'==data.message)?noproducts=true:noproducts=false):(responseData=data)),status:response.status}))).catch(error=>console.error('NetworkError:',alert('NETWORK ERROR::'+error)))
var content=document.getElementById('contentDiv');for(let i=0;i<responseData.products.length;i++){var service=document.createElement('div');const formatter=new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',});var price=formatter.format(responseData.products[i].price);let images=responseData.products[i].images.split(",");var slider=`<div class="flex flex-wrap -m-4 text-center swiper "><div class="swiper-wrapper">`;for(let i=0;i<images.length;i++){slider+=`<div class="p-4 md:w-1/4 sm:w-1/2 w-full swiper-slide"><div class="border-2 border-gray-200 px-4 py-6 rounded-lg swiper-zoom-container "><img alt="gallery"class=" object-cover aspect-square object-center block"
src="./assets/images/SuperExclusives/${images[i]}.jpeg"></div></div>`;}
slider+=`</div><div class="swiper-button-next"></div><div class="swiper-button-prev"></div><div class="swiper-pagination"></div></div>`;service.className="p-4 xl:w-1/4 md:w-1/2 w-full";service.innerHTML=`<div
class="h-full p-6 rounded-lg border-2 bg-white shadow-md shadow-black border-primary1 flex flex-col relative overflow-hidden"><span class="bg-primary1 text-white px-3 py-1 tracking-widest text-xs absolute right-0 top-0 rounded-bl">${responseData.products[i].company}</span><h2 class="text-sm tracking-widest title-font mb-1 font-medium">${responseData.products[i].model}</h2><h1
class="text-1xl font-semibold text-gray-900 leading-none flex items-center pb-4 mb-4 border-b border-gray-200"><span>${price}(USDC)</span></h1>${slider}<br><p class="flex items-center text-gray-600 mb-2 text-sm"><span
class="w-4 h-4 mr-2 inline-flex items-center justify-center bg-primary1 text-white rounded-full flex-shrink-0"><svg fill="none"stroke="currentColor"stroke-linecap="round"stroke-linejoin="round"stroke-width="2.5"
class="w-3 h-3"viewBox="0 0 24 24"><path d="M20 6L9 17l-5-5"></path></svg></span>Year:${responseData.products[i].year}</p><p class="flex items-center text-gray-600 mb-2 text-sm"><span
class="w-4 h-4 mr-2 inline-flex items-center justify-center bg-primary1 text-white rounded-full flex-shrink-0"><svg fill="none"stroke="currentColor"stroke-linecap="round"stroke-linejoin="round"stroke-width="2.5"
class="w-3 h-3"viewBox="0 0 24 24"><path d="M20 6L9 17l-5-5"></path></svg></span>Specs:${responseData.products[i].spec}</p><p class="flex items-center text-gray-600 mb-2 text-sm"><span
class="w-4 h-4 mr-2 inline-flex items-center justify-center bg-primary1 text-white rounded-full flex-shrink-0"><svg fill="none"stroke="currentColor"stroke-linecap="round"stroke-linejoin="round"stroke-width="2.5"
class="w-3 h-3"viewBox="0 0 24 24"><path d="M20 6L9 17l-5-5"></path></svg></span>Kms:${responseData.products[i].kms}</p><button id="pay${i}"
class="shadow-md shadow-black flex items-center mt-auto text-white  bg-primary2 hover:bg-primary1 border-0 py-2 px-4 w-full focus:outline-none  rounded disabled:opacity-25"
onclick="payNow('${responseData.products[i].price}','pay${i}');"${(metamaskEnabled)?'':'disabled'}>${(metamaskEnabled)?'Buy Now':'MetaMask not found!'}<svg fill="none"stroke="currentColor"stroke-linecap="round"stroke-linejoin="round"stroke-width="2"
class="w-4 h-4 ml-auto"viewBox="0 0 24 24"><path d="M5 12h14M12 5l7 7-7 7"></path></svg></button><p class="text-xs text-gray-500 mt-3">For any support related to this car please reach out to<a class="text-blue-600"href="mailto:support@iih.ae?subject=Support Request for ${responseData.products[i].model}&body=Please describe your support needs.">support@iih.ae</a></p></div>`;content.appendChild(service);}
const swiper=new Swiper('.swiper',{zoom:true,navigation:{nextEl:".swiper-button-next",prevEl:".swiper-button-prev",},pagination:{el:".swiper-pagination",clickable:true,},});document.getElementById("loadButton").classList.add('hidden');}
export async function payNow(amount,pid){document.getElementById(pid).disabled=true;document.getElementById(pid).innerHTML=`Processing...`;document.getElementById(pid).classList.add('animate-pulse');await switchToMatic();const provider=await new ethers.BrowserProvider(window.ethereum)
const signer=await provider.getSigner()
const USDCMaticTokenContract=await new ethers.Contract('0x2791Bca1f2de4661ED88A30C99A7a9449Aa84174',USDCABI(),signer);const txn=await USDCMaticTokenContract.transfer('0x9bCFac4aD4C259b8f3262566d7faBfaBc1601250',ethers.parseUnits(amount,6)).then((transaction)=>{console.dir("RESULT::"+transaction)
alert("Payment Initiated")
transaction.wait()
then((receipt)=>{alert("Payment Successful")}).catch(err=>alert("ERROR::"+err.reason))}).catch(err=>alert(err.reason))
document.getElementById(pid).disabled=false;document.getElementById(pid).innerHTML=`Buy Now`;document.getElementById(pid).classList.remove('animate-pulse');}
export async function withdrawNow(){if(!confirm('Are you sure that you have enough balance in your contract to initiate withdrawal ?')){return;}
const provider=await new ethers.BrowserProvider(window.ethereum)
const signer=await provider.getSigner()
await switchToMatic();const DeployedContract=await new ethers.Contract('0x9bCFac4aD4C259b8f3262566d7faBfaBc1601250',PAY_V1_ABI(),signer);const txn=await DeployedContract.settleFunds('0x2791Bca1f2de4661ED88A30C99A7a9449Aa84174',{gasLimit:3000000}).then((transaction)=>{console.dir("RESULT::"+transaction)
alert("Withdraw Initiated")
transaction.wait()
then((receipt)=>{alert("Withdraw Successful")}).catch(err=>alert("ERROR::"+err.reason))}).catch(err=>alert(err.reason))}